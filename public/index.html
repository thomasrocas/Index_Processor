<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CSV Upload</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f7f9fc;
      margin: 0;
      padding: 40px;
    }
    .container {
      max-width: 520px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    h2 { text-align: center; margin-top: 0; }
    label { display: block; margin: 15px 0 5px; }
    select, input[type="file"], button {
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      margin-top: 20px;
    }
    button:hover { background: #0056b3; }
    #status { margin-top: 16px; font-weight: bold; white-space: pre-wrap; }
    .muted { color: #555; font-size: 12px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Upload CSV to Database</h2>
    <form id="uploadForm" enctype="multipart/form-data">
      <label for="tableName">Select Table:</label>
      <select name="tableName" id="tableName" required>
        <option value="" disabled selected>-- Choose a table --</option>
        <option value="casemanager">Case Manager</option>
        <option value="maintable">Main Table</option>
        <option value="billed_ar_aging">Billed AR Aging</option>
        <option value="queue_manager">Queue Manager</option>
        <option value="unduplicatedpatients">Unduplicated Census</option>
        <option value="admissions">Admissions</option>
        <option value="active_agency">Active Agency Census</option>
        <option value="pdgm">PDGM</option>
        <option value="referrals">Referrals</option>
        <option value="raw_data">Raw Data</option>
      </select>

      <label for="csvFile">Choose CSV File:</label>
      <input type="file" name="csvfile" id="csvFile" accept=".csv" required>

      <button type="submit">Upload</button>
    </form>
    <div class="muted">Tip: Main Table requires a "Visit ID". Raw Data requires an "Admission ID". Unduplicated and Referrals use an "MRN" key. Admissions uses the combination of "MRN" and "Admission Date".</div>
    <div id="status"></div>
  </div>

  <script>
    const form = document.getElementById("uploadForm");
    const statusBox = document.getElementById("status");
    let progressWatcher = null;

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const tableName = document.getElementById("tableName").value;
      const fileInput = document.getElementById("csvFile");
      const file = fileInput.files[0];
      if (!file) return alert("Please select a file.");

      statusBox.textContent = "Uploading to table: " + tableName + "\nPreparing import...";

      if (tableName === "maintable") {
        processAndUploadCSV(file, tableName);
      } else {
        uploadDirect(file, tableName);
      }
    });

    async function uploadDirect(file, tableName) {
      const formData = new FormData();
      formData.append("csvfile", file);
      formData.append("tableName", tableName);

      try {
        const response = await fetch("/upload", { method: "POST", body: formData });
        const payload = await readJsonResponse(response);
        if (!payload.importId) {
          throw new Error(payload.error || "Import session could not be created.");
        }

        statusBox.textContent = [
          `Import queued for ${tableName}.`,
          `Import ID: ${payload.importId}`,
          "Awaiting progress..."
        ].join("\n");

        startProgressWatcher(payload.importId);
      } catch (err) {
        statusBox.textContent += `\n❌ ${err.message}`;
      }
    }

    async function readJsonResponse(response) {
      const text = await response.text();
      let data = null;
      try {
        data = text ? JSON.parse(text) : null;
      } catch (_) {
        data = null;
      }

      if (!response.ok) {
        const message = data?.error || data?.message || text || "Upload failed.";
        throw new Error(message);
      }

      return data || {};
    }

    function startProgressWatcher(importId) {
      if (progressWatcher && typeof progressWatcher.stop === "function") {
        progressWatcher.stop();
      }

      let stopped = false;
      let timer = null;

      const stop = () => {
        if (!stopped) {
          if (timer) clearInterval(timer);
          stopped = true;
          progressWatcher = null;
        }
      };

      const poll = async () => {
        try {
          const res = await fetch(`/progress/${encodeURIComponent(importId)}`);
          const text = await res.text();
          let snapshot = null;
          try {
            snapshot = text ? JSON.parse(text) : null;
          } catch (_) {
            snapshot = null;
          }

          if (!res.ok) {
            const message = snapshot?.error || snapshot?.message || text || "Unable to fetch progress.";
            throw new Error(message);
          }

          renderProgress(snapshot);

          if (snapshot.status === "completed" || snapshot.status === "failed") {
            stop();
          }
        } catch (err) {
          stop();
          statusBox.textContent += `\n⚠️ Progress check failed: ${err.message}`;
        }
      };

      progressWatcher = { stop };
      poll();
      timer = setInterval(poll, 1000);
    }

    function renderProgress(snapshot) {
      if (!snapshot) return;

      const lines = [];
      if (snapshot.tableName) {
        lines.push(`Table: ${snapshot.tableName}`);
      }
      if (snapshot.id) {
        lines.push(`Import ID: ${snapshot.id}`);
      }
      lines.push(`Status: ${formatStatus(snapshot.status)}`);

      if (snapshot.totalRows) {
        lines.push(`Processed: ${snapshot.processedRows} / ${snapshot.totalRows}`);
      } else {
        lines.push(`Processed: ${snapshot.processedRows}`);
      }

      if (typeof snapshot.percentage === "number") {
        lines.push(`Progress: ${snapshot.percentage}%`);
      }

      if (snapshot.status === "completed" && snapshot.summary) {
        lines.push("", "Summary:");
        lines.push(`Processed Rows: ${snapshot.summary.processedRows}`);
        lines.push(`Inserted/Updated: ${snapshot.summary.insertedOrUpdated}`);
        lines.push(`Deleted Rows: ${snapshot.summary.deletedCount}`);
        lines.push(`Skipped Rows: ${snapshot.summary.skippedRows}`);
        if (snapshot.message) {
          lines.push("", snapshot.message);
        }
      } else if (snapshot.status === "failed") {
        if (snapshot.error) {
          lines.push("", `Error: ${snapshot.error}`);
        }
      }

      statusBox.textContent = lines.join("\n");
    }

    function formatStatus(status) {
      switch (status) {
        case "queued":
          return "Queued";
        case "importing":
          return "Importing";
        case "completed":
          return "Completed";
        case "failed":
          return "Failed";
        default:
          return status || "Unknown";
      }
    }

    function processAndUploadCSV(file, tableName) {
      Papa.parse(file, {
        complete: function(results) {
          let data = results.data;

          for (let col = data[0].length - 1; col >= 0; col--) {
            if ((data[0][col] || "").trim() === "") {
              data.forEach(row => {
                if (row.length > col) row.splice(col, 1);
              });
            }
          }

          data[0] = data[0].map(h => (h || "").trim());

          const socDateIndex = data[0].indexOf("SOC Date");
          const visitStartDateIndex = data[0].indexOf("Visit Start Date");

          data[0].push("cRecertDate_Current", "cRecertDate_Next", "cRecertDate_End");

          for (let i = 1; i < data.length; i++) {
            const socDate = parseDate(data[i][socDateIndex]);
            const visitStartDate = parseDate(data[i][visitStartDateIndex]);

            let cRecertDateCurrent = "", cRecertDateNext = "", cRecertDateEnd = "";

            if (socDate && visitStartDate && socDate <= visitStartDate) {
              const recertDate = calculateCRecertDate(socDate, visitStartDate);
              if (recertDate) {
                const recertDateNext = new Date(recertDate.getTime());
                recertDateNext.setDate(recertDateNext.getDate() + 1);

                const recertDateEnd = new Date(recertDate.getTime());
                recertDateEnd.setDate(recertDateEnd.getDate() + 59);

                cRecertDateCurrent = formatDate(recertDate);
                cRecertDateNext = formatDate(recertDateNext);
                cRecertDateEnd = formatDate(recertDateEnd);
              }
            }

            data[i].push(cRecertDateCurrent, cRecertDateNext, cRecertDateEnd);
          }

          const modifiedCSV = Papa.unparse(data);
          const blob = new Blob([modifiedCSV], { type: "text/csv" });
          const processedFile = new File([blob], "processed_" + file.name, { type: "text/csv" });

          uploadDirect(processedFile, tableName);
        }
      });
    }

    function parseDate(value) {
      if (!value) return null;
      const parts = value.split('/');
      if (parts.length !== 3) return null;
      const [month, day, year] = parts.map(Number);
      if (!month || !day || !year) return null;
      return new Date(year < 100 ? 2000 + year : year, month - 1, day);
    }

    function calculateCRecertDate(socDate, visitStartDate) {
      const diff = Math.floor((visitStartDate - socDate) / (1000 * 60 * 60 * 24));
      if (diff < 0) return null;
      return new Date(socDate.getTime() + diff * 24 * 60 * 60 * 1000);
    }

    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }
  </script>
</body>
</html>
